- [react å·¥ä½œæµç¨‹](#react-å·¥ä½œæµç¨‹)
  - [Virtual DOM](#virtual-dom)
    - [What?](#what)
    - [Why? ç‚ºä»€éº¼è¦ä½¿ç”¨ VODM?](#why-ç‚ºä»€éº¼è¦ä½¿ç”¨-vodm)
    - [Where? åœ¨å“ªè£¡ä½¿ç”¨ VDOM?](#where-åœ¨å“ªè£¡ä½¿ç”¨-vdom)
    - [How? react ä¸­å¦‚ä½•ä½¿ç”¨ VDOM?](#how-react-ä¸­å¦‚ä½•ä½¿ç”¨-vdom)
  - [react çš„æ¶æ§‹](#react-çš„æ¶æ§‹)
    - [èª¿åº¦å±¤ Scheduler](#èª¿åº¦å±¤-scheduler)
    - [å”èª¿å±¤ Reconciler](#å”èª¿å±¤-reconciler)
    - [æ¸²æŸ“å±¤ Renderer](#æ¸²æŸ“å±¤-renderer)
  - [å¾ react element åˆ° fiber tree](#å¾-react-element-åˆ°-fiber-tree)
    - [æ›´æ–°çš„æœ¬è³ª](#æ›´æ–°çš„æœ¬è³ª)
    - [æ™‚é–“åˆ‡ç‰‡ time slice](#æ™‚é–“åˆ‡ç‰‡-time-slice)
    - [å·¥ä½œéç¨‹](#å·¥ä½œéç¨‹)
      - [é›™ç·©å­˜ fiber tree](#é›™ç·©å­˜-fiber-tree)
      - [å‰µå»ºæ›´æ–° tree](#å‰µå»ºæ›´æ–°-tree)
    - [èª¿å’Œ Reconcile](#èª¿å’Œ-reconcile)
  - [diff ç®—æ³•](#diff-ç®—æ³•)
    - [æ ¸å¿ƒæ€æƒ³](#æ ¸å¿ƒæ€æƒ³)
    - [æ¯”è¼ƒéç¨‹](#æ¯”è¼ƒéç¨‹)
      - [æƒ…æ³ 1 - before: åˆ—è¡¨ï¼Œafter: å–®ç¯€é»](#æƒ…æ³-1---before-åˆ—è¡¨after-å–®ç¯€é»)
      - [æƒ…æ³ 2 - before: åˆ—è¡¨ï¼Œafter: åˆ—è¡¨](#æƒ…æ³-2---before-åˆ—è¡¨after-åˆ—è¡¨)
        - [ğŸŒ° ç‚º type éƒ½ä¸€è‡´çš„æƒ…æ³ï¼Œåªæœ‰ key ä¸åŒçš„æƒ…æ³](#-ç‚º-type-éƒ½ä¸€è‡´çš„æƒ…æ³åªæœ‰-key-ä¸åŒçš„æƒ…æ³)
        - [ğŸŒ° key æ²’æœ‰è¨­ç½®æˆ–ä¸åŒçš„æƒ…æ³](#-key-æ²’æœ‰è¨­ç½®æˆ–ä¸åŒçš„æƒ…æ³)
      - [åˆ¤æ–·æ–°å»ºçš„ç¯€é»ï¼Œæ˜¯å¦æœ‰è®ŠåŒ–](#åˆ¤æ–·æ–°å»ºçš„ç¯€é»æ˜¯å¦æœ‰è®ŠåŒ–)
      - [ç™¼ç”Ÿè®ŠåŒ–å¾Œè¦å¦‚ä½•æ›´æ–°ï¼Ÿ](#ç™¼ç”Ÿè®ŠåŒ–å¾Œè¦å¦‚ä½•æ›´æ–°)
  - [Effect](#effect)
  - [Fiber](#fiber)
    - [fiber æ˜¯ä»€éº¼ï¼Ÿ](#fiber-æ˜¯ä»€éº¼)
      - [å¼•å…¥çš„èƒŒæ™¯](#å¼•å…¥çš„èƒŒæ™¯)
      - [åŸºæœ¬æ¦‚å¿µ](#åŸºæœ¬æ¦‚å¿µ)
    - [æºç¢¼ä¸­çš„ Fiber](#æºç¢¼ä¸­çš„-fiber)
  - [ç”¨ç°¡å–®çš„æ¨¡æ“¬å”èª¿éç¨‹](#ç”¨ç°¡å–®çš„æ¨¡æ“¬å”èª¿éç¨‹)
    - [éæ­·é †åºå’Œ render éšæ®µ](#éæ­·é †åºå’Œ-render-éšæ®µ)
    - [commit éšæ®µ - æ”¶é›† Effect List](#commit-éšæ®µ---æ”¶é›†-effect-list)
  - [å¸¸æåˆ°çš„å°ˆæœ‰åè© - å¢é‡å¼æ¸²æŸ“ (Incremental Rendering)ã€ä½µç™¼æ¨¡å¼ (Concurrent Mode)](#å¸¸æåˆ°çš„å°ˆæœ‰åè©---å¢é‡å¼æ¸²æŸ“-incremental-renderingä½µç™¼æ¨¡å¼-concurrent-mode)
    - [å¢é‡å¼æ¸²æŸ“ (Incremental Rendering)](#å¢é‡å¼æ¸²æŸ“-incremental-rendering)
    - [ä½µç™¼æ¨¡å¼ (Concurrent Mode)](#ä½µç™¼æ¨¡å¼-concurrent-mode)
  - [é‡é»æ•´ç†](#é‡é»æ•´ç†)

---

# react å·¥ä½œæµç¨‹

## Virtual DOM

### What?

- å®è§€ä¾†èªªï¼šåˆç¨±ç‚º VDOMï¼Œæ˜¯ä¸€ç¨®ç·¨ç¨‹æ¦‚å¿µï¼Œç”± React åœ¨ 2013 ç‡å…ˆé–‹æ‹“ï¼Œå¾ŒçºŒè¢«è¨±å¤šä¸åŒçš„æ¡†æ¶æ¡ç”¨ã€‚
  åœ¨é€™å€‹æ¦‚å¿µè£¡é¢ï¼ŒUI ä»¥ä¸€ç¨®ç†æƒ³åŒ–çš„ï¼Œæˆ–è€…èªªæ˜¯è™›æ“¬çš„å½¢å¼è¢«ä¿å­˜åœ¨å…§å­˜ä¸­ï¼Œé€šé ReactDOM ç­‰å¥—ä»¶åŒ…è½‰æ›ï¼Œä½¿å®ƒè·ŸçœŸçš„çš„ DOM åŒæ­¥ã€‚åŒæ­¥çš„éç¨‹åœ¨ react ç•¶ä¸­ç¨±ä¹‹ç‚ºèª¿å’Œæˆ–æ˜¯å”èª¿ Reconcileã€‚è€Œå”èª¿çš„æ ¸å¿ƒå°±æ˜¯ VDOM diff ç®—æ³•ã€‚

- å¾®è§€ä¾†èªªï¼šç”¨ç‰©ä»¶è¡¨ç¾ DOM çš„ä¿¡æ¯å’Œçµæ§‹ï¼Œç•¶ç‹€æ…‹è®Šæ›´æ™‚ï¼Œé‡æ–°æ¸²æŸ“é€™å€‹ç‰©ä»¶çµæ§‹ï¼Œé€™å€‹å°è±¡å°±ç¨±ç‚º VDOMã€‚

### Why? ç‚ºä»€éº¼è¦ä½¿ç”¨ VODM?

DOM æ“ä½œå¾ˆæ…¢ï¼Œè¼•å¾®çš„æ“ä½œéƒ½å¯ä»¥å¼•ç™¼é‡æ–°æ’ç‰ˆï¼Œéå¸¸æ¶ˆè€—æ€§èƒ½ã€‚ç›¸å°æ–¼ DOM å°è±¡ï¼Œ js å°è±¡è™•ç†èµ·ä¾†æ›´å¿«æ›´ç°¡å–®ã€‚é€šé DIFF ç®—æ³•å°æ¯”æ–°èˆŠ VDOM å·®ç•°ï¼Œå¯ä»¥æ‰¹é‡çš„ï¼Œæœ€å°åŒ–çš„åŸ·è¡Œ DOM æ“ä½œï¼Œå¾è€Œæå‡ç”¨æˆ¶é«”é©—ã€‚

### Where? åœ¨å“ªè£¡ä½¿ç”¨ VDOM?

react ç•¶ä¸­ç”¨ jsx ä¾†è¡¨ç¾è¦–åœ–ï¼Œåœ¨ v17 ä¹‹å‰ï¼Œå¿…é ˆç¶“é `babel-loader` è½‰è­¯ç‚º `React.createElement(...)` èª¿ç”¨ï¼Œè¿”å› ReactElememtã€‚
åœ¨ v17 ä¹‹å¾Œï¼Œæ–°çš„è½‰æ›ï¼Œè‡ªå‹•å¾ React çš„ package ä¸­å¼•å…¥æ–°çš„å…¥å£å‡½å¼ä¸¦èª¿ç”¨ã€‚
<font color="red" size="2">âŒ ä¸èƒ½èªª JSX = VDOMï¼Œä¹Ÿä¸èƒ½èªª ReactElement = VDOM</font>

### How? react ä¸­å¦‚ä½•ä½¿ç”¨ VDOM?

1. JSX å¯¦éš›æ˜¯ä¸€ç¨® **JS èªæ³•æ“´å±•**ï¼Œä»–å…è¨±é–‹ç™¼è€…ç”¨é¡ä¼¼ HTML çš„èªæ³•ä¾†å¯«çµ„ä»¶ã€‚æ˜¯ä¸€ç¨®**èªæ³•ç³–**ã€‚

2. å„ªé»

   - JSX ç·¨å¯«å¿«é€Ÿé«˜æ•ˆ
   - ç·¨è­¯ç‚º JS å¾Œé€²è¡Œäº†å„ªåŒ–ï¼ŒåŸ·è¡Œæ›´å¿«
   - åœ¨ç·¨è­¯éç¨‹ä¸­ï¼Œå°±èƒ½ç™¼ç¾éŒ¯èª¤

3. èˆ‡ vue æ¯”è¼ƒ
   - vue æ¼”é€²å¾Œæ‰æœ‰ vdom + templete
   - jsx åŸå…ˆå°±æ˜¯ js æ“´å±•ï¼Œè½‰è­¯éç¨‹ç°¡å–®ç›´æ¥; vue æŠŠ templete è½‰è­¯ç‚º render å‡½å¼çš„éç¨‹éœ€è¦è¤‡é›œçš„ç·¨è­¯å™¨è½‰æ› -> å­—ç¬¦ä¸² -> ast -> js

## react çš„æ¶æ§‹

åœ¨ v16 ç‰ˆæœ¬ä¸­å°±é–‹å§‹åˆ†ç‚ºä¸‰å±¤ï¼šèª¿åº¦å±¤ã€å”èª¿å±¤ã€æ¸²æŸ“å±¤

- **èª¿åº¦å±¤ Scheduler** : èª¿åº¦ä»»å‹™çš„å„ªå…ˆç´šï¼Œé«˜å„ªå…ˆç´šçš„å„ªå…ˆé€²å…¥å”èª¿å±¤
- **å”èª¿å±¤ Reconciler** : æ§‹å»º fiber treeï¼Œdiff æ¯”å°ï¼Œæ‰¾å‡ºå·®ç•°ï¼Œæ¨™è¨˜ fiber node æº–å‚™è¦é€²è¡Œçš„ dom æ“ä½œ
- **æ¸²æŸ“å±¤ Renderer** : è² è²¬å°‡ç™¼ç”Ÿè®ŠåŒ–çš„éƒ¨åˆ†æ¸²æŸ“åˆ°é é¢ä¸Š

### èª¿åº¦å±¤ Scheduler

- v15 åŸå…ˆç”¨éæ­¸é€²è¡Œ vdom çš„æ¯”å°ï¼Œä¸­é–“æ˜¯åŒæ­¥é€²è¡Œï¼Œç„¡æ³•ä¸­æ–·ï¼Œé•·æœŸä½”ç”¨ä¸»ç·šç¨‹ï¼Œæœƒå°è‡´ç•«é¢ç„¡æ³•äº¤äº’æˆ–æ˜¯æ‰å¹€çš„ç‹€æ³ã€‚
- v16 ä¹‹å¾Œæ¡ç”¨ **å¾ªç’°éæ­¸** ï¼Œä¸¦ä¸”åˆ©ç”¨ç€è¦½å™¨ç©ºé–‘æ™‚é–“è™•ç†ã€‚åŸå…ˆ react æƒ³åˆ©ç”¨ `requestIdleCallback` ä½†æœ€çµ‚æ”¯æ´åº¦å’Œè§¸ç™¼é »ç‡ä¸ç©©å®šç­‰å•é¡Œï¼Œæ”¹å®˜æ–¹è‡ªèº«å¯¦ç¾ä»»å‹™èª¿åº¦ï¼Œé€™å€‹åº«å°±å«åš [Scheduler](./packages/scheduler/README.md) ã€‚å¯ä»¥å¯¦ç¾ç€è¦½å™¨ç©ºé–’æ™‚åŸ·è¡Œä»»å‹™ï¼Œé‚„å¯ä»¥èª¿åº¦ä»»å‹™çš„å„ªå…ˆç´šï¼Œé«˜å„ªå…ˆç´šçš„å„ªå…ˆé€²å…¥å”èª¿å±¤ã€‚é€™ä¸€å±¤ç¢ºå®šäº†å“ªäº›ä»»å‹™æ‡‰è©²è¢«åŸ·è¡Œï¼Œå“ªäº›ä»»å‹™å¯ä»¥æ¨é²åŸ·è¡Œã€‚èª¿åº¦å±¤ä¸¦ä¸ç›´æ¥åŸ·è¡Œæ¸²æŸ“ï¼Œè€Œæ˜¯é€šéå”èª¿å±¤ä¾†è§¸ç™¼æ¸²æŸ“ã€‚

### å”èª¿å±¤ Reconciler

- å”èª¿å±¤æ˜¯ React ä¸­çš„æ ¸å¿ƒé‚è¼¯ï¼Œè² è²¬æ§‹å»º Fiber æ¨¹ï¼ˆå³è™›æ“¬ DOM çš„çµæ§‹ï¼‰ï¼Œä¸¦é€²è¡Œ diff æ¯”å°ã€‚å®ƒé‚„æœƒæ¨™è¨˜éœ€è¦æ›´æ–°çš„ Fiber ç¯€é»ï¼Œä¸¦ç¢ºå®šå“ªäº› DOM æ“ä½œæ˜¯å¿…é ˆåŸ·è¡Œçš„ã€‚
- v15 åŸå…ˆå”èª¿å™¨å’Œæ¸²æŸ“å™¨äº¤æ›¿å·¥ä½œï¼Œæ‰¾å‡ºå·®ç•°å°±æ›´æ–°ã€‚
- v16 å”èª¿å™¨åªæ˜¯æ‰¾å‡ºå·®ç•°å¾Œæ¨™è¨˜ï¼Œä¹‹å¾Œäº¤çµ¦æ¸²æŸ“å™¨æ›´æ–°ã€‚

### æ¸²æŸ“å±¤ Renderer

æ¸²æŸ“å±¤çš„è²¬ä»»æ˜¯æ ¹æ“šå”èª¿å±¤ä¸­ç”Ÿæˆçš„ Fiber æ¨¹ï¼Œå°‡ç›¸æ‡‰çš„è®Šæ›´æœ€çµ‚æ‡‰ç”¨åˆ°å¯¦éš›çš„ DOM ä¸Šã€‚
è¦æ³¨æ„çš„æ˜¯ï¼Œèª¿åº¦å±¤å’Œå”èª¿å±¤æ˜¯åœ¨å…§å­˜ä¸­è™•ç†ï¼Œæ‰€ä»¥å¯ä»¥è¢«æ‰“æ–·ï¼Œä½†æ¸²æŸ“å™¨è¢«è¨­å®šä¸å¯ä¸­æ–·ã€‚

## å¾ react element åˆ° fiber tree

- v17 ä¹‹å‰ï¼Œjsx ç¶“é babel å¾Œï¼Œè½‰è­¯ç‚º `React.createElement`ã€‚
- v17 ä¹‹å¾Œï¼Œå’Œ babel é€²è¡Œäº†åˆä½œï¼Œä½¿ç”¨ babel é€²è¡Œä¸Šè¿°çš„è™•ç†ï¼Œæ‰€ä»¥åœ¨ React17.0 æˆ‘å€‘ä¸ç”¨å¼•å…¥ React ä¹Ÿå¯ä»¥é‹è¡Œæˆ‘å€‘çš„ jsxï¼Œè‡ªå‹•å¾å¥—ä»¶åŒ…ä¸­å¼•å…¥æ–°çš„å…¥å£å‡½å¼èª¿ç”¨ï¼Œä¸€æ¨£è¿”å› react elementã€‚

åŸ·è¡Œå¾Œè¿”å› react elementï¼Œå†è½‰æ›æˆ **fiber tree**ï¼Œå°æ‡‰åˆ° **dom tree**ï¼Œåœ¨æ§‹å»º tree çš„éç¨‹ä¸­ä»¥[æ·±åº¦å„ªå…ˆéæ­·](./DFS.md)çš„æ–¹å¼ï¼Œå¾ child å»¶ä¼¸ï¼Œç›´åˆ° child å®Œæˆå¾Œå°‹æ‰¾ return æŒ‡å‘ ï¼Œå†æ‰¾ sibling æŒ‡å‘ã€‚
é¦–å±æ¸²æŸ“å®Œæˆå¾Œï¼Œé€²å…¥äº¤äº’æ›´æ–°éšæ®µã€‚
æ›´æ–°æ™‚æœƒç”¢ç”Ÿå…©å€‹ **fiber tree**ï¼Œä¸€æ£µæ˜¯å°æ‡‰ç•¶å‰é¡¯ç¤ºï¼Œä¸€å€‹æ˜¯å°æ‡‰æ›´æ–°å°‡è¦é¡¯ç¤º **workInProgress fiber tree**ï¼Œæ›´æ–°å®Œæˆå¾Œ å³æ›¿æ›æ‰èˆŠçš„ã€‚

---

### æ›´æ–°çš„æœ¬è³ª

éœ€è¦å°‡ fiber tree æ›´æ–°å®Œæˆå¾Œï¼Œæ›´æ–° dom tree åŸ·è¡Œç”Ÿå‘½é€±æœŸæ–¹æ³•
react å…§éƒ¨å°‡ä¸€æ¬¡æ›´æ–°åˆ†ç‚ºå…©å€‹éšæ®µï¼Œ**render**ã€**commit**ã€‚

1. render: éæ­· fiber æ¨¹(VDOM)ï¼Œæ¯”è¼ƒæ–°èˆŠç¯€é»ï¼Œè¨ˆç®—éœ€è¦æ›´æ–°çš„éƒ¨åˆ†ã€‚åˆåˆ†ç‚ºå…©éšæ®µ
   1. beginWork: æŒ‰ç…§ workInProgress tagï¼ŒåŸ·è¡Œå­ç¯€é»çš„ fiber å‰µå»º
      - çœ‹æœ‰æ²’æœ‰è¦èµ° diffï¼Œèµ°åˆ° bailout
      - æ²’æœ‰å­ç¯€é»å‰‡åœæ­¢ï¼Œè¿”å›å­ç¯€é»ï¼ˆæ·±åº¦å„ªå…ˆï¼Œä¸€è·¯åŸ·è¡Œ child)
   2. completeUnitWork: å¾ªç’°åŸ·è¡Œå‰µå»ºçœŸå¯¦ DOM
      - æŠŠ workInProgress è½‰ç§»æŒ‡é‡åˆ°åŒå±¤ç´šçš„å…„å¼Ÿç¯€é»ï¼Œå›åˆ° beginWorkï¼Œç›´åˆ°æ‰€æœ‰å…„å¼Ÿç¯€é»èˆ‡å…¶å­ç¯€é»éƒ½å®Œæˆï¼Œé€™æ™‚æŒ‡é‡è½‰ç§»åˆ°çˆ¶ç¯€é»ä¸Šï¼Œå› ç‚ºæ­¤æ™‚çš„çˆ¶ç¯€é»å·²ç¶“åŸ·è¡Œé beginWorkï¼Œä¸éœ€è¦è·³å‡º completeUnitWork çš„è¿´åœˆï¼ŒåŸ·è¡Œ DOM å‰µå»ºä¹‹é¤˜ï¼ŒæŠŠæ‰€æœ‰æœ‰ stateNode çš„å­ç¯€é»ï¼ˆéœ€è¦ç•¥é Fragmentã€child === nullï¼‰å…¨éƒ¨ appendAllChildren åˆ°çˆ¶ç¯€é» stateNode ä¸­ã€‚ä»¥ä¸Š é‡è¤‡ç›´åˆ°æ ¹ç¯€é»ã€‚
1. commit: VDOM -> DOM

- ğŸŒŸ éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

  - render éšæ®µæ˜¯å¯ä»¥è¢«ä¸­æ–·å’Œæš«åœçš„
    - åœ¨ä½µç™¼æ¨¡å¼ä¸‹ï¼Œå¯ä¸­æ–·å…ˆè™•ç†é«˜å„ªå…ˆç´šçš„ä»»å‹™ï¼Œç¨å¾Œå†ç¹¼çºŒã€‚fiber æ¶æ§‹æ”¯æŒæ™‚é–“åˆ‡ç‰‡ï¼Œæ¯æ¬¡åªåŸ·è¡Œä¸€å°éƒ¨åˆ†ï¼Œå‰©é¤˜çš„éƒ¨åˆ†ç¨å¾Œå¯ä»¥ç¹¼çºŒ
    - éç¨‹ï¼šå¾"æ ¹ç¯€é»"é–‹å§‹éæ­·ï¼Œæ¨™è¨˜éœ€è¦æ›´æ–°çš„ç¯€é»ã€å‰µå»ºå’Œæ›´æ–°æ¨¹
  - **commit æ˜¯ä¸å¯è¢«æ‰“æ–·çš„**
    - å°‡éœ€è¦æ›´æ–°çš„éƒ¨åˆ†æ¸²æŸ“åˆ°çœŸå¯¦ DOM ä¸Šï¼Œä¸¦ä¸”è§¸ç™¼ç”Ÿå‘½é€±æœŸå’Œå‰¯ä½œç”¨ã€‚
    - **æ˜¯åŒæ­¥é€²è¡Œçš„**ï¼Œå› ç‚ºç›´æ¥æ“ä½œ DOM æˆ–æ˜¯è§¸ç™¼å‰¯ä½œç”¨ï¼Œç‚ºäº†ä¿è­‰æ›´æ–°çš„å®Œæ•´æ€§ï¼Œé¿å… DOM çš„ç‹€æ…‹ä¸ä¸€è‡´æˆ–å‰¯ä½œç”¨å°è‡´æ„å¤–è¡Œç‚º
    - éç¨‹ï¼š
      1. åŸ·è¡ŒæŸäº›ç”Ÿå‘½é€±æœŸæ–¹æ³•ï¼ˆå¦‚ getSnapshotBeforeUpdateï¼‰
      2. å°‡è®ŠåŒ–æ‡‰ç”¨åˆ° DOM æˆ–å…¶ä»–ç›®æ¨™
      3. åŸ·è¡Œå‰¯ä½œç”¨ï¼Œå¦‚ `componentDidMount`ã€`useEffect` çš„ `cleanup` å’Œ `setup`

#### ä½å„ªå…ˆç´šçš„å·¥ä½œè¢«æ‰“æ–·è™•ç†é«˜å„ªå…ˆç´šå¾Œçš„æµç¨‹ï¼Ÿ

- ä»»å‹™çš„ç‹€æ…‹
  - fiber æœƒè¨˜è¼‰æ˜¯å¦å·²ç¶“å®Œæˆï¼Œç•¶å‰æ˜¯å¦éœ€è¦æ›´æ–°
  - ä½å„ªå…ˆç´šçš„ä»»å‹™æœƒä¿ç•™åœ¨ updateQueue BaseQueue éšŠåˆ—ä¸Šï¼Œå†è½‰ç§»æ§åˆ¶æ¬Š
- ä½å„ªå…ˆç´šçš„ fiber ç‹€æ…‹
  - è¢«æ‰“æ–·çš„ä½å„ªå…ˆç´šçš„ fiber å­æ¨¹æœƒä¿ç•™ï¼Œä½†ä¸æœƒæäº¤ commit
  - ui é¡¯ç¤ºçš„ä»ç„¶æ˜¯ä¹‹å‰å·²ç¶“æäº¤çš„ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰ç”¨æˆ¶å·²ç¶“çœ‹åˆ°çš„æœ€å¾Œä¸€æ¬¡æˆåŠŸ commit çš„ç‹€æ…‹
- æ¢å¾©ä½å„ªå…ˆç´šä»»å‹™
  - æœƒå¾ä¸­æ–·çš„ä½ç½®ç¹¼çºŒï¼Œä¸æœƒå¾é ­é–‹å§‹
  - æœƒé‡æ–°æª¢æŸ¥ä¸­æ–·æœŸé–“æ˜¯å¦åˆæœ‰æ–°çš„æ›´æ–°è¢«åŠ å…¥ï¼Œæˆ–æ˜¯æ›´æ–°è¢«åˆä½µï¼Œæˆ–æ˜¯å„ªå…ˆç´šè¢«èª¿æ•´

#### æºç¢¼ç•¶ä¸­çš„ renderRootConcurrent å’Œ renderRootSync

åœ¨æºç¢¼ç•¶ä¸­ï¼Œæœƒçœ‹åˆ° `performConcurrentWorkOnRoot`

```ts
// ! åœ¨æŸäº›æƒ…æ³ä¸‹ï¼Œæœƒç¦æ­¢ä½¿ç”¨æ™‚é–“åˆ‡ç‰‡
// å¦‚æœ work è¨ˆç®—æ™‚é–“éé•·ï¼Œï¼ˆç‚ºäº†é˜²æ­¢é£¢é¤“è€Œå°‡å®ƒè¦–ç‚ºéæœŸçš„ä»»å‹™ï¼‰
// æˆ–è€…æˆ‘å€‘è™•æ–¼é»˜èªå•Ÿå‹•åŒæ­¥çš„æ¨¡å¼
const shouldTimeSlice =
  !includesBlockingLane(root, lanes) && // ! åˆæ¬¡æ¸²æŸ“ æœƒåœ¨åŒæ­¥æ›´æ–°è£¡é¢
  !includesExpiredLane(root, lanes) && // ! å¾ŒçºŒåƒè€ƒ useDeferredValuePage ä¾‹å­
  (disableSchedulerTimeoutInWorkLoop || !didTimeout);

let exitStatus = shouldTimeSlice
  ? renderRootConcurrent(root, lanes) // ! å¾ŒçºŒåƒè€ƒ useDeferredValuePage ä¾‹å­
  : renderRootSync(root, lanes); // ! ä¸ä½¿ç”¨æ™‚é–“åˆ‡ç‰‡
```

å»èª¿ç”¨ä¸åŒçš„ renderRoot æ¨¡å¼ï¼Œç©¶ç«Ÿæœ‰ä»€éº¼ä¸åŒï¼Ÿ

```ts
function workLoopConcurrent() {
  // Perform work until Scheduler asks us to yield
  // ! å¦‚æœæ˜¯éç·Šæ€¥æ›´æ–°ï¼Œèª¿ç”¨ scheduler çœ‹æ™‚é–“åˆ‡ç‰‡ï¼Œæ˜¯å¦è¦ä¸­æ–·
  while (workInProgress !== null && !shouldYield()) {
    // $FlowFixMe[incompatible-call] found when upgrading Flow
    performUnitOfWork(workInProgress);
  }
}

function workLoopSync() {
  console.log(
    "%c [ workLoopSync ]: ",
    "color: #fff; background: #000; font-size: 13px;",
    ""
  );
  // ! performUnitOfWorkå’ŒcompleteUnitOfWorkåˆä½œå®Œæˆäº†ä¸€å€‹æ·±åº¦å„ªå…ˆæœå°‹çš„é‚è¼¯ï¼Œéæ­·äº†æ•´å€‹DOM æ¨¹ï¼Œç”¢ç”Ÿäº†Fiber æ¨¹"
  // Perform work without checking if we need to yield between fiber.
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress);
  }
}
```

å¯ä»¥çœ‹åˆ°æ’åœ¨ä¸€å€‹ `shouldYield`ï¼Œèª¿ç”¨äº†ä¾†è‡ª `scheduler` åŒ…ä¸­çš„å‡½å¼ï¼Œå¯ä»¥åˆ¤æ–·æ˜¯å¦æ™‚é–“åˆ‡ç‰‡çš„æœŸé™å·²åˆ°ï¼Œäº¤é‚„æ§åˆ¶æ¬Šçµ¦ç€è¦½å™¨ã€‚ä½†é€™æœ‰ä»€éº¼ä¸åŒï¼Ÿ

å…ˆçœ‹åˆ° `workLoopSync` ä»–æ˜¯è™•ç†å®Œä¸€æ•´å€‹å­ç¯€é»åŒ…å«ä»–çš„ å­æ¨¹å€‘ï¼æ˜¯ä¸€å€‹ä»»å‹™ã€‚ä½† `workLoopConcurrent` æ˜¯è™•ç†ä¸€å€‹ç¯€é»å¾Œï¼Œè¦è™•ç†ä¸‹ä¸€å€‹ç¯€é»æ™‚ï¼Œæª¢æŸ¥ï¼æ˜¯å°‡æ•´å€‹å”èª¿çš„å·¥ä½œåˆ†æˆå¾ˆå¤šå°ç‰‡æ®µã€‚

- `workLoopConcurrent`: æ¯è™•ç†ä¸€å€‹ç¯€é»æª¢æŸ¥
  - æ˜¯å¦è¶…å‡ºæ™‚é–“é ç®—(5ms)
  - æ˜¯å¦æœ‰æ›´é«˜å„ªå…ˆç´šçš„ä»»å‹™
- `workLoopSync`: æœƒåŒæ­¥å®Œæˆæ•´å€‹ fiber éæ­·å’Œå”èª¿ï¼Œæœƒå¾æ ¹ç¯€é»é–‹å§‹ï¼ŒæŒ‰æ·±åº¦å„ªå…ˆå®Œæˆæ‰€æœ‰çš„å·¥ä½œï¼Œä¸å¯ä¸­æ–·ã€‚ä¸­é–“ä¹Ÿä¸æœƒæª¢æŸ¥æˆ–è™•ç†å…¶ä»–ä»»å‹™ï¼Œåªèƒ½ç­‰å¾…ç•¶å‰ä»»å‹™å®Œæˆã€‚
  - åˆæ¬¡æ¸²æŸ“ã€ä¸æ”¯æŒä½µç™¼çš„ä»»å‹™ï¼ˆLegacy Mode æˆ–æ˜¯ é—œéµç”Ÿå‘½é€±æœŸã€å‰¯ä½œç”¨é‚è¼¯ã€éŒ¯èª¤é‚Šç•Œï¼‰ã€é«˜å„ªå…ˆç´šçš„ä»»å‹™ï¼ˆå¦‚ç”¨æˆ¶ä¸»å‹•è§¸ç™¼çš„ç·Šæ€¥æ›´æ–°ï¼‰
  - ç”¨æˆ¶åœ¨äº¤äº’ä¸Šå¯èƒ½æœƒæ„Ÿåˆ°å¡é “

#### ç•¶æœ‰é«˜å„ªå…ˆç´šçš„ä»»å‹™ï¼Ÿè¦æ€éº¼ä¸­æ–·è™•ç†ï¼Ÿ

èª¿ç”¨ `ensureRootIsScheduled` ï¼Œæª¢æŸ¥ç•¶å‰æ˜¯å¦å·²ç¶“æœ‰ä»»å‹™åœ¨åŸ·è¡Œï¼Ÿ
å¦‚æœå·²ç¶“æœ‰ä»»å‹™ï¼Œæœƒæ‹¿ç•¶å‰æ–°åŠ å…¥çš„ä»»å‹™çš„ï¼Œæ–°çš„ fiberRootNode ä¸Šçš„ pendingLanes å’Œæ­£åœ¨é€²è¡Œä¸­çš„ä»»å‹™å„ªå…ˆç´šæ¯”è¼ƒï¼ˆæ–°åŠ å…¥ä»»å‹™æ™‚ï¼Œæœƒæ›´æ–° fiberRootNode ä¸Šçš„ pendingLanesï¼‰ã€‚æ±ºå®šæ˜¯å¦è¦é‡æ–°å®‰æ’èª¿åº¦ã€‚
æ–°çš„é«˜å„ªå…ˆç´šçš„ä»»å‹™æœƒé€é Scheduler åŠ å…¥èª¿åº¦éšŠåˆ—ã€‚å†æ¬¡å¾ æ ¹ç¯€é»æ§‹å»º fiber æ¨¹ã€‚é«˜å„ªå…ˆç´šçš„ä»»å‹™çš„ lane æœƒå…ˆè¦†è“‹ workInProgress æ¨¹çš„ lanesï¼Œè™•ç†å®Œæˆå¾Œå†å¾©åŸ

```js
              [ç”¨æˆ¶è§¸ç™¼æ›´æ–°]
                    â†“
            [æ›´æ–°æ·»åŠ åˆ°æ›´æ–°éšŠåˆ—]
                    â†“
      [æ›´æ–° fiberRootNode.pendingLanes]
                    â†“
    [èª¿ç”¨ ensureRootIsScheduled æª¢æŸ¥èª¿åº¦]
                    â†“
    [Scheduler ä¸­æ–·ç•¶å‰ä»»å‹™ï¼Œè™•ç†é«˜å„ªå…ˆç´šä»»å‹™]
                    â†“
       [å¾ fiberRootNode æ ¹ç¯€é»é–‹å§‹å”èª¿]

```

### æ™‚é–“åˆ‡ç‰‡ time slice

åœ¨å–®ç·šç¨‹çš„æ©Ÿåˆ¶ä¸‹ï¼Œå¦‚æœä¸€å€‹ä»»å‹™åŸ·è¡Œæ™‚é–“èŠ±è²»éä¹…ï¼Œå°±æœƒå µå¡å¾Œé¢çš„ä»»å‹™ã€‚
react æ¸²æŸ“æ™‚ï¼Œ**é«˜å„ªå…ˆç´šçš„ä»»å‹™ï¼ˆex: äº¤äº’ã€ä½ˆå±€ï¼‰è¢«æŸå€‹ä»»å‹™å µå¡äº†**ï¼Œè¢å¹•å°±æœƒå‡ºç¾å¡é “ã€‚ç‚ºäº†è§£æ±ºé€™ç¨®å•é¡Œï¼Œreact æ“ç…§æ“ä½œç³»çµ±ï¼Œå¼•å…¥äº†æ™‚é–“åˆ‡ç‰‡çš„æ©Ÿåˆ¶ï¼Œ**åœ¨æŸå€‹æ™‚é–“æ®µå…§é€±æœŸæ€§åŸ·è¡Œä»»å‹™ï¼Œé€±æœŸæ€§åœ°æŠŠæ§åˆ¶æ¬Šäº¤é‚„çµ¦ç€è¦½å™¨ã€‚**

![stackReconciler](./assets/stackReconciler.jpeg)
![fiberReconciler](./assets/workloop.webp)

æ¯å€‹ work å·¥ä½œå–®å…ƒçš„æ™‚é•·æ˜¯ 5msï¼Œè¶…éåŸ·è¡Œæ™‚é–“ï¼Œå°±è¦æŠŠæ§åˆ¶æ¬Šäº¤é‚„çµ¦ç€è¦½å™¨

```js
// å½ä»£ç¢¼
// æ™‚é–“åˆ‡ç‰‡çš„èµ·å§‹ï¼Œæ™‚é–“æˆ³
let startTime = -1;
// æ™‚é–“åˆ‡ç‰‡ï¼Œé€™æ˜¯å€‹æ™‚é–“æ®µ
let frameInterval = 5;

function shouldYieldToHost() {
  const timeElapsed = performance.now() - startTime;
  return timeElapsed >= frameInterval;
}
```

### å·¥ä½œéç¨‹

åˆ†ç‚ºå…©éšæ®µ

- å•Ÿå‹•éšæ®µï¼šé¦–å±æ¸²æŸ“çš„æ•´å€‹éç¨‹ï¼Œå¾ç„¡åˆ°æœ‰å»ºæ§‹ fiber tree å’Œ dom treeã€‚
- äº¤äº’éšæ®µï¼šç™¼ç”Ÿäº¤äº’æ”¹è®Šçµæ§‹ã€‚

#### é›™ç·©å­˜ fiber tree

åœ¨å…§å­˜ç•¶ä¸­æ§‹å»ºï¼Œå®Œæˆå¾Œæ›¿æ›ä¸Šä¸€å¹€ï¼Œæ¯”åœ¨æ¸²æŸ“æ™‚æ‰æ§‹å»ºè¦å¿«ï¼é€™å€‹æŠ€è¡“å°±å«åšé›™ç·©å­˜ã€‚

- `current fiber tree`: ç•¶å‰è¢å¹•é¡¯ç¤ºçš„æ¨¹
- `workInProgress fiber tree`: æ›´æ–°ç”¢ç”Ÿçš„æ¨¹ã€‚
  æ›´æ–°å®Œæˆå¾Œ `workInProgress fiber tree` æœƒå–ä»£ `current fiber tree`ã€‚
- alternate: é€™å€‹æŒ‡é‡å­˜åœ¨å…©æ£µæ¨¹ä¸Šï¼ŒæŒ‡å‘å½¼æ­¤ï¼Œå¦‚æœè¦æ›´æ–°ï¼Œæœƒæ›¿æ›æ‰èˆŠçš„æ¨¹ã€‚
- flags: æ¨™è¨˜æ›´æ–°çš„å…§å®¹ï¼Œæ¯”æ–¹åˆªé™¤æ›´æ–°æ’å…¥ç­‰ç­‰çš„è®ŠåŒ–ã€‚

#### å‰µå»ºæ›´æ–° tree

createElement åŸ·è¡Œå®Œç•¢å¾Œï¼ŒåŸ·è¡Œ renderï¼Œæ­£å¼é€²å…¥æ§‹å»ºéšæ®µï¼Œåœ¨ root å®¹å™¨ç¯€é»ä¸Šå»ºç«‹ fiber nodeï¼Œä¾æ¬¡å‰µå»ºå­ç¯€é»ã€‚
æ¯”è¼ƒéº»ç…©çš„æ˜¯æ›´æ–°ã€‚

1. æ¨™è¨˜ç™¼ç”Ÿæ›´æ–°çš„ç¯€é»ï¼Œè¤‡è£½æ ¹ç¯€é»ä½œç‚º `workInProgress fiber tree` çš„æ ¹ç¯€é»ï¼Œä¸¦ä¸”ä¹Ÿæœ‰æŒ‡é‡æŒ‡å‘èˆŠæ¨¹çš„ childã€‚
2. `current fiber tree` æœƒæœ‰ä¸€å€‹æŒ‡é‡ `current` æŒ‡å‘ç›®å‰è™•ç†çš„å°è±¡ï¼ŒåŒæ¨£ `workInProgress fiber tree` ä¹Ÿæœ‰ï¼Œå«åš`workInProgress`ã€‚
3. æª¢æŸ¥ `workInProgress` æŒ‡å‘çš„ç¯€é»æœ‰æ²’æœ‰è®ŠåŒ–ï¼Œå‰‡è¤‡è£½ `current` æŒ‡å‘çš„ child çµ¦ `workInProgress fiber tree`ï¼Œä¸¦ç§»å‹•æŒ‡é‡ `workInProgress` å’Œ `current`> APP
4. APP æœ‰æ¨™è¨˜ Updateï¼Œè¤‡è£½ç¯€é»åˆ° `workInProgress fiber tree`ï¼Œå†æª¢æŸ¥ APP çš„å­ç¯€é»ï¼Œreact Element å’Œ current.child æ¯”è¼ƒï¼Œç™¼ç¾ä¸€æ¨£å†è¤‡è£½ï¼Œï¼Œä¸¦ç§»å‹•æŒ‡é‡ `workInProgress` å’Œ `current`ã€‚ä»¥æ­¤æ–¹å¼é‡è¤‡æµç¨‹ã€‚
5. å¦‚æœç™¼ç¾è¦åˆªé™¤çš„ç¯€é»ï¼Œå‰‡æ¨™è¨˜åˆªé™¤; å¦‚æœç™¼ç¾è¦æ–°å¢çš„ï¼Œå‰‡`current`æŒ‡å‘ nullï¼Œ`workInProgress`æŒ‡å‘æ–°å¢çš„çµæ§‹
6. æœ€å¾Œç§»å‹•æŒ‡é‡ `workInProgress` å’Œ `current`> æ ¹ç¯€é»ï¼Œfiber root node å†æŠŠ current æŒ‡é‡æŒ‡å‘æ–°çš„æ¨¹ï¼Œå°±æ›´æ–°å®Œæˆã€å†è™•ç†å‰¯ä½œç”¨ï¼ˆåŒ…å« dom ç¯€é»ç§»é™¤ï¼ŒuseEffect çš„ destory è§¸ç™¼ï¼‰

### èª¿å’Œ Reconcile

èª¿æ•´ fiber tree çš„çµæ§‹å’Œæ›´æ–°ä»¥å¾Œçš„ jsx, dom tree ä¸€è‡´ï¼Œåœ¨èª¿å’Œéç¨‹ä¸­æ•´å€‹èª¿å’Œçš„éç¨‹å°±ç™¼ç”Ÿåœ¨ `workInProgress fiber tree`ï¼Œèª¿å’Œçš„æ™‚å€™ä¸»è¦åšä¸‰ä»¶äº‹

1. ç”Ÿæˆ fiber nodeï¼Œä½¿ç”¨ diff ç®—æ³•ï¼Œåˆ¤æ–·è¦ clone é‚„æ˜¯è¦ create

   - <u>clone</u>: å¦‚æœåœ¨ `current fiber tree` ä¸Šæœ‰æ‰¾åˆ°åŒ¹é…çš„ç¯€é»ï¼Œç›´æ¥è¤‡ç”¨ç¯€é»ï¼Œåªéœ€è¦æ›´æ–°ç¯€é»å±¬æ€§æˆ–æ˜¯ç§»å‹•ç¯€é»ã€‚
   - <u>create</u>: å¦‚æœåœ¨ `current fiber tree` ä¸Šæ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„ç¯€é»ï¼Œå‰‡å‰µå»ºã€‚
   - <u>reuse</u>ï¼šä¸ç”¨åšä»»ä½•è™•ç†ã€‚å¦‚æœ `shouldComponentUpdate` æˆ–æ˜¯ `memo` åŒ…è£¹å„ªåŒ–å¾Œï¼Œrender æ–¹æ³•ä¸ç”¨åŸ·è¡Œã€‚å¯ä»¥åŠ å¿« `workInProgress fiber tree` èª¿å’Œã€‚

2. æ‰¾åˆ°ç™¼ç”Ÿè®ŠåŒ–çš„ nodeï¼Œæ›´æ–° fiber nodeï¼Œæ¨™è¨˜å‰¯ä½œç”¨
3. æ”¶é›†å¸¶ fiber çš„å‰¯ä½œç”¨

## diff ç®—æ³•

ã€`workInProgress fiber tree` çš„ `react element`ã€ å’Œ ã€`current fiber tree` ä¸­çš„ `fiber node`ã€æ¯”è¼ƒï¼Œtype (component æˆ– dom ç¯€é» æˆ– react æä¾›çš„æ¨™ç±¤) å’Œ key å®Œå…¨ä¸€è‡´æ‰å¯ä»¥ cloneã€‚
é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼åˆ—è¡¨éƒ½éœ€è¦æœ‰ keyï¼Œä»–å¯ä»¥ç›£è½åˆ°å…ƒç´ æ˜¯å¦ç™¼ç”Ÿç§»å‹•æ–°å¢åˆªé™¤ï¼Œå¯ä»¥å„ªåŒ–æ¸²æŸ“éç¨‹ã€‚

### æ ¸å¿ƒæ€æƒ³

- ä»¥åŒ¹é…çš„çˆ¶ç¯€é»çš„å­ç¯€é»åšæ¯”è¼ƒï¼Œä¸è·¨çˆ¶ç¯€é»æ¯”è¼ƒã€‚
- key çš„å„ªå…ˆç´šå¤§æ–¼ typeã€‚

### æ¯”è¼ƒéç¨‹

#### æƒ…æ³ 1 - before: åˆ—è¡¨ï¼Œafter: å–®ç¯€é»

1. å¦‚æœæœ‰åŒ¹é…åˆ°æŸå€‹ç¯€é» -> cloneï¼Œ`workInProgress fiber node` çš„ `alternate æŒ‡é‡` æŒ‡å‘ç¯€é»ã€‚å‰©ä¸‹çš„æ¨™è¨˜ç‚ºåˆªé™¤ã€‚
2. å¦‚æœæœ‰åŒ¹é…åˆ°æŸå€‹ç¯€é» -> createï¼Œ`workInProgress fiber node` çš„ `alternate æŒ‡é‡` æŒ‡å‘ nullã€‚

#### æƒ…æ³ 2 - before: åˆ—è¡¨ï¼Œafter: åˆ—è¡¨

éœ€è¦åˆ¤æ–·æœ‰æ²’æœ‰ç§»å‹•ï¼
åœ¨éç¨‹ç•¶ä¸­æœƒå®šç¾©ä¸€å€‹ `lastPlacedIndex` çš„æŒ‡é‡æ¨™ç¤ºæ²’æœ‰ç§»å‹•çš„ node

- å¦‚æœ `lastPlacedIndex` > oldIndex å‰‡è¡¨ç¤º ä»–ç™¼ç”Ÿäº†ç§»å‹•ï¼Œè¦ç§»åˆ° `lastPlacedIndex` ä¹‹å¾Œ
- å¦‚æœ `lastPlacedIndex` <= oldIndex å‰‡è¡¨ç¤º æ²’æœ‰ç§»å‹•ï¼Œæ”¹è®Š `lastPlacedIndex` çš„æŒ‡å‘

##### ğŸŒ° ç‚º type éƒ½ä¸€è‡´çš„æƒ…æ³ï¼Œåªæœ‰ key ä¸åŒçš„æƒ…æ³

```js
// before current fiber tree
         div   --sibling-->  div   --sibling-->  div  --sibling-->  div
         key:A               key:B               key:C             key:D
index:     0                   1                   2                 3

// after workInProgress fiber tree
         div   --sibling-->  div   --sibling-->  div  --sibling-->  div
         key:C               key:B               key:A             key:D
index:     0                   1                   2                 3
```

å¾ workInProgress fiber tree é–‹å§‹

1. ç¬¬ä¸€å€‹ç¯€é» C: åŒ¹é…åˆ° `current fiber tree` çš„ Cï¼Œindex: 2ï¼Œå®šç¾©å®ƒç‚ºæœªç§»å‹•çš„ç¯€é»ã€‚
   `lastPlacedIndex` = 2
2. ç¬¬äºŒå€‹ç¯€é» B: åŒ¹é…åˆ° `current fiber tree` çš„ B index: 1 < `lastPlacedIndex`ï¼Œè¡¨ç¤ºä»–ç§»å‹•åˆ°äº†å¾Œé¢
3. ç¬¬ä¸‰å€‹ç¯€é» A: åŒ¹é…åˆ° `current fiber tree` çš„ A index: 0 < `lastPlacedIndex`ï¼Œè¡¨ç¤ºä»–ç§»å‹•åˆ°äº†å¾Œé¢
4. ç¬¬å››å€‹ç¯€é» D: åŒ¹é…åˆ° `current fiber tree` çš„ D index: 3 >= `lastPlacedIndex`ï¼Œæœªç§»å‹•
   `lastPlacedIndex` = 3

##### ğŸŒ° key æ²’æœ‰è¨­ç½®æˆ–ä¸åŒçš„æƒ…æ³

- æ²’æœ‰è¨­ç½® key: ä¸€é–‹å§‹æœƒä¸€åŒéæ­·ï¼Œtype ç›¸åŒå°± cloneï¼Œä¸ç›¸åŒå°± createï¼ŒæŠŠèˆŠçš„æ‰“ä¸Šåˆªé™¤è¨˜è™Ÿã€‚é‡åˆ°æœ‰ key å€¼å‡ºç¾äº†æœƒæ”¹è®ŠåŒ¹é…çš„æ–¹å¼ã€‚é€²å…¥ç¬¬äºŒéšæ®µã€‚
- key å€¼å‡ºç¾äº†ï¼Œä½†ä¸åŒ: ç”Ÿæˆä¸€å€‹ Mapï¼Œkey ç‚º `current fiber node` çš„ key(|| index)ï¼Œç¹¼çºŒéæ­·æ–°çš„æ¨¹ï¼Œå¦‚æœæœ‰åœ¨ Map ä¸­åŒ¹é…åˆ°å°± cloneï¼Œä¸ç„¶å°±æ–°å»ºã€‚Map ä¸­å…¶ä»–æ²’æœ‰åŒ¹é…åˆ°çš„ å…¨éƒ¨æ¨™è¨˜åˆªé™¤è¨˜è™Ÿã€‚

```js
// before current fiber tree
      div  --sibling-->  div --sibling-->  div --sibling-->  div  --sibling-->  div --sibling-->  div --sibling--> div --sibling--> div
                                          key:A             key:B             key:C              key:D             key:E            key:F
idx:   0                  1                 2                 3                  4                 5                6                 7

// after workInProgress fiber tree
       p  --sibling-->  div --sibling-->  div --sibling-->  div  --sibling-->  div --sibling-->  div
                                         key:B            key:A               key:G             key:D
idx:   0                 1                 2                 3                  4                 5
```

å¾ workInProgress fiber tree é–‹å§‹

1. ç¬¬ä¸€å€‹ç¯€é» p: `current fiber node[0]` çš„ divï¼Œkey === undefinedï¼Œtype ä¸ç›¸åŒï¼Œp è¦ createï¼Œdiv æ¨™è¨˜åˆªé™¤
2. ç¬¬äºŒå€‹ç¯€é»: `current fiber node[1]` çš„ divï¼Œkey === undefinedï¼Œtype ç›¸åŒï¼Œ
   `lastPlacedIndex` = 1
3. ç¬¬ä¸‰å€‹ç¯€é» B: åŒ¹é…åˆ° `current fiber tree` çš„ Aï¼Œkey ä¸ç›¸åŒï¼Œç”Ÿæˆä¸€å€‹ Map æŠŠå‰©ä¸‹çš„ `current fiber node` æ”¾é€²å»ï¼ŒåŒ¹é…åˆ°äº† Bï¼Œ
   åˆªé™¤ Map[B]
   `lastPlacedIndex` = 2
4. ç¬¬å››å€‹ç¯€é» A: åŒ¹é…åˆ° Map[A]ï¼Œæ¨™è¨˜ç§»å‹•
   åˆªé™¤ Map[A]
   `lastPlacedIndex` = 2
5. ç¬¬äº”å€‹ç¯€é» G: æ²’æœ‰åŒ¹é…ï¼Œå‰µæ–°çš„ï¼Œæ¨™è¨˜æ–°å¢
6. ç¬¬å…­å€‹ç¯€é» D: åŒ¹é…åˆ° Map[D]
   åˆªé™¤ Map[D]
   `lastPlacedIndex` = 5
7. Map ä¸­å‰©ä¸‹çš„ç¯€é»æ¨™è¨˜åˆªé™¤

#### åˆ¤æ–·æ–°å»ºçš„ç¯€é»ï¼Œæ˜¯å¦æœ‰è®ŠåŒ–

åˆ¤æ–· props æœ‰ç„¡æ”¹è®Šï¼Œé€šéæ¯”è¼ƒå…©è€…å°±å¯ä»¥çŸ¥é“æ˜¯å¦è¦æ›´æ–°å±¬æ€§
`workInProgress fiber node` çš„ `props`: `pendingProps`
`current fiber node` çš„ `props`: `memoizedProps`

#### ç™¼ç”Ÿè®ŠåŒ–å¾Œè¦å¦‚ä½•æ›´æ–°ï¼Ÿ

åˆ¤æ–· type çµ¦äºˆä¸åŒçš„ tag åšä¸åŒçš„è™•ç†ã€‚
æ¯ä¸€æ¬¡ react element å‰µå»ºæ™‚ props éƒ½æ˜¯ä¸€å€‹æ–°å°è±¡ï¼Œ`pendingProps` ä¹Ÿä¸€å®šå’Œ `memoizedProps`ä¸ä¸€æ¨£ã€‚
é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ ç•¶å­ç¯€é»æ˜¯ä¸€å€‹çµ„ä»¶æ™‚ï¼Œå„˜ç®¡ props å±¬æ€§æ²’æœ‰æ”¹è®Šï¼Œä½†ä¾èˆŠæœƒè§¸ç™¼ render æ–¹æ³•ï¼Œç•¶å­çµ„ä»¶çš„ props å’Œ state æœ‰è®ŠåŒ–ï¼Œç¯€é»éƒ½æœƒæ›´æ–°ã€‚

## Effect

Effect åˆåˆ†å¾ˆå¤šé¡å‹

- Placement: è¡¨ç¯€é»éœ€è¦ç§»å‹•æˆ–æ·»åŠ 
- Update: æ›´æ–°ï¼Œæ¯”æ–¹èªª props è®ŠåŒ–ï¼Œä½¿ç”¨äº† useEffectã€useLayoutEffectï¼Œ
- PlacementAndUpdate: åˆç§»å‹•åˆè®ŠåŒ–
- Ref: åˆå§‹åŒ–è¦è³¦å€¼
- Deletion: è§¸ç™¼ useEffectã€useLayoutEffect è¿”å›çš„ destory
- Snapshot: é¡çµ„ä»¶ getSnapshotBeforeUpdate
- Passive: å…ˆåŸ·è¡Œ useEffect è¿”å›çš„ destory å†ç•°æ­¥åŸ·è¡Œ useEffect callback
- Layout: å…ˆåŸ·è¡Œ useEffect è¿”å›çš„ destory å†åŒæ­¥åŸ·è¡Œ useEffect callback
  ...

v17ï¼šåœ¨èª¿å’Œå®Œæˆå¾Œï¼Œæœƒæ”¶å°‡è¢«æ¨™è¨˜ Effect çš„ fiber node æ”¶é›†æˆä¸€å€‹å–®éˆè¡¨çµæ§‹ï¼Œé€šé nextEffect æŒ‡é‡é€£æ¥ï¼Œç”±æœ€ä¸‹å±¤çš„å­ç¯€é»é–‹å§‹æ”¶é›†ã€‚
æ”¶é›†å®Œæˆå¾Œï¼Œåˆ†ä¸‰éšæ®µè™•ç†ï¼š

1. dom æ“ä½œä¹‹å‰ï¼Œ before mutation
   - è™•ç† Snapshot
2. dom æ“ä½œï¼Œmutation
   - è™•ç† Deletionã€Placementã€Updateã€PlacementAndUpdate
   - åŸç”Ÿçš„ API setAttributeã€removeArrributeã€innerHtmlã€textContentï¼Œä¿®æ”¹ styleï¼ŒappendChildã€insertBeforeã€removeChild
   - componentWillUnmountã€useEffect destoryã€ref æ¸…ç©º
   - ...
3. layoutï¼Œmutation
   - ref.current åˆå§‹åŒ–
   - useLayoutEffect
   - ...

v18ï¼šä»¥é›™å‘éˆè¡¨ä¾†å­˜å„²ï¼Œæ¯å€‹ç¯€é»åŒ…å«äº†è¦åŸ·è¡Œçš„å‰¯ä½œç”¨å’Œå°æ‡‰çš„æ¸…ç†å‡½æ•¸
// TODO: å¾…è£œå……

## Fiber

### fiber æ˜¯ä»€éº¼ï¼Ÿ

fiber ä¸æ˜¯ React ç¨æœ‰çš„ï¼Œæ˜¯ä¸€ç¨®å¸¸è¦‹çš„è¨ˆç®—æ©Ÿè¡“èªã€‚åœ¨ Ruby, PHP ä¸­éƒ½æœ‰æ‡‰ç”¨ã€‚å¯ä¸­æ–·å¯æš«åœã€‚

react ä¸­æ˜¯æŒ‡ä¸€ç¨®æ•¸æ“šçµæ§‹ï¼Œåœ¨ v16 ç‰ˆæœ¬ä¸­å¼•å…¥çš„é‡å¤§æ”¹è®Šï¼Œç›®çš„æ˜¯ä½¿ react æ¸²æŸ“æ›´åŠ éˆæ´»ä¸”é«˜æ•ˆï¼Œä¸¦æ”¯æŒ**ç•°æ­¥æ¸²æŸ“**å’Œ**å„ªå…ˆç´šæ¸²æŸ“**ã€‚

#### å¼•å…¥çš„èƒŒæ™¯

v16 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨ä¸€ç¨® **stack reconciliation** çš„æ¸²æŸ“ç®—æ³•ã€‚é€™ç¨®ç®—æ³•åœ¨è™•ç†æ¸²æŸ“éç¨‹æ˜¯**åŒæ­¥**çš„ï¼Œæ¯ç•¶æœ‰ç‹€æ…‹æ›´æ–°æˆ–æ˜¯ UI è®ŠåŒ–æ™‚ï¼Œreact éƒ½æœƒåŸ·è¡Œä¸€æ¬¡å®Œæ•´çš„æ¸²æŸ“éç¨‹ï¼Œç›´åˆ°æ‰€æœ‰æ›´æ–°å®Œæˆã€‚åœ¨é€™å€‹éç¨‹ç•¶ä¸­æœƒé˜»å¡ä¸»ç·šç¨‹ï¼Œå°è‡´ UI å¡é “ã€‚

Fiber çš„å¼•å…¥å°±æ˜¯ç‚ºäº†è®“æ¸²æŸ“éç¨‹è®Šæˆç•°æ­¥ï¼Œå°‡æ¸²æŸ“æ‹†åˆ†å¤šå¡Šï¼Œåˆ†æ•£åœ¨ä¸åŒå¹€è™•ç†ã€‚ä¸¦ä¸”èƒ½æ ¹æ“šå„ªå…ˆç´šé€²è¡Œä»»å‹™èª¿åº¦ã€‚

#### åŸºæœ¬æ¦‚å¿µ

æ¯å€‹ Fiber è¡¨ç¤ºä¸€å€‹ UI çµ„ä»¶ï¼Œä¸Šé¢æœ‰å„ç¨®å±¬æ€§ï¼Œç´€éŒ„ç›¸é—œçš„ä¿¡æ¯ï¼Œæœ‰ç¯€é»å¯¦ä¾‹ã€å­ç¯€é» childã€å…„å¼Ÿç¯€é» silblingã€çˆ¶ç¯€é» returnã€å„ªå…ˆç´šç­‰ç­‰ã€‚
ä¹Ÿæ˜¯æŒ‡ä¸€å€‹å°‡è¦åŸ·è¡Œæˆ–è€…æ˜¯å·²ç¶“åŸ·è¡Œå®Œæˆçš„å·¥ä½œå–®å…ƒ (unit of work)ï¼Œä¸€å€‹çµ„ä»¶å¯ä»¥æœ‰ä¸€å€‹è‡³å¤šå€‹ fiberã€‚

1. æ›è¼‰ä¸åŒçš„å„ªå…ˆç´šï¼Œå¯æš«åœã€çµ‚æ­¢ã€è¤‡ç”¨å·¥ä½œå–®å…ƒ(unit of work)ï¼Œçµ¦ä½µç™¼æä¾›åŸºç¤ï¼š
   - å› ç‚ºâ€œæ™‚é–“åˆ‡ç‰‡â€ï¼‹â€œå¢é‡æ¸²æŸ“â€çš„æ©Ÿåˆ¶ï¼Œå°‡æ¸²æŸ“éç¨‹åˆ†ç‚ºå¤šå€‹å°å–®å…ƒï¼Œé€™æ¨£å°±å¯ä»¥ä¸­é€”æš«åœï¼Œè™•ç†æ›´é«˜å„ªå…ˆç´šçš„ä»»å‹™ï¼ˆæ¯”å¦‚ç”¨æˆ¶äº¤äº’ï¼‰ã€‚
   - å¯ä»¥å¯¦ç¾â€œä½µç™¼â€æ¨¡å¼(Concurrent Mode)ï¼Œä½¿å¾—é«˜å„ªå…ˆç´šçš„æ›´æ–°ï¼ˆå¦‚ç”¨æˆ¶é»æ“Šï¼‰èƒ½å¤ æ›´å¿«åœ°å¾—åˆ°è™•ç†ï¼Œè€Œä½å„ªå…ˆç´šçš„æ›´æ–°ï¼ˆå¦‚å‹•ç•«ã€æ•¸æ“šåŠ è¼‰ï¼‰å‰‡å¯ä»¥æ¨é²ã€‚
2. Fiber tree æ›´å¥½çš„ DIFF æ¯”å°æ›´æ–°ï¼š
   - workInProgress tree: æŒ‡æ­£åœ¨é€²è¡Œçš„å·¥ä½œå–®å…ƒï¼Œçµ„å»ºè€Œæˆçš„æ¨¹ç‹€çµæ§‹
   - current tree: èˆŠçš„ fiberï¼Œå·²ç¶“åŸ·è¡Œå®Œæˆçš„ work ï¼Œçµ„å»ºè€Œæˆçš„æ¨¹ç‹€çµæ§‹ã€‚å°æ‡‰åˆ°æœªæ›´æ–°å‰çš„ç‹€æ…‹ã€‚

![browser](./assets/browser.webp)
![real](./assets/real.webp)

### æºç¢¼ä¸­çš„ Fiber

> [!TIP] æºç¢¼ç­†è¨˜
> [react-debugger/src/react/packages/react-reconciler/src/ReactInternalTypes.js](./react-debugger/src/react/packages/react-reconciler/src/ReactInternalTypes.js)

## ç”¨ç°¡å–®çš„æ¨¡æ“¬å”èª¿éç¨‹

### éæ­·é †åºå’Œ render éšæ®µ

é€™é‚Šæš«æ™‚å…ˆç”¨ window.requestIdleCallback

1. è«‹æ±‚ç€è¦½å™¨åˆ†é…æ™‚é–“æ®µï¼ŒåŸ·è¡Œä»»å‹™
2. ç”¨è®Šæ•¸ `nextUnitWork` ä¾†è¨˜ä¸‹ä¸€å€‹è¦è™•ç†çš„ node
3. å¦‚æœé‚„æœ‰æ™‚é–“ä¸” `nextUnitWork` é‚„æœ‰ç¯€é»å°šæœªè™•ç†ï¼Œå‰‡é€²å…¥è™•ç†å·¥ä½œ
4. å‰µå»º dom ç¯€é»ï¼Œæ¨™è¨˜å®Œæˆ
5. å®Œæˆå¾Œå°‡ `nextUnitWork` æŒ‡å‘ç¯€é»çš„ childï¼Œï¼Œé‡è¤‡ 4.ï¼Œ
   - å¦‚æœæ²’æœ‰ childï¼Œ`nextUnitWork` æŒ‡å‘ç¯€é»çš„ sibilingï¼Œé‡è¤‡ 4.
   - å¦‚æœä¹Ÿå®Œæˆï¼Œå‰‡ `nextUnitWork` æŒ‡å‘ç¯€é»çš„ return
6. render éšæ®µå®Œæˆï¼Œæº–å‚™é€²å…¥ commit éšæ®µ

### commit éšæ®µ - æ”¶é›† Effect List

1. å°‡å¾…æœ‰å‰¯ä½œç”¨çš„ fiber node ç¯€é»æ”¶é›†èµ·ä¾†ï¼Œå½¢æˆä¸€å€‹å–®éˆè¡¨ã€‚
2. é€šé commitWork æ–¹æ³•ï¼Œå°‡æ”¶é›†çš„å‰¯ä½œç”¨é€²è¡Œæäº¤ï¼Œä¿®æ”¹çœŸå¯¦çš„ dom
3. Effect List çš„é †åºå’Œ fiber ç¯€é»éæ­·çš„å®Œæˆé †åºä¸€è‡´
   ![effect](./assets/image.png)
   ![collect](./assets/collect.webp)

```js
//   <div id="A1">
//     <div id="B1">
//       <div id="C1"></div>
//       <div id="C2"></div>
//     </div>
//     <div id="B2"></div>
//   </div>

let container = document.getElementById("root");
let C1 = { type: "div", key: "C1", props: { id: "C1", children: [] } };
let C2 = { type: "div", key: "C2", props: { id: "C2", children: [] } };
let B1 = {
  type: "div",
  key: "B1",
  props: { id: "B1", children: [C1, C2] },
};
let B2 = { type: "div", key: "B2", props: { id: "B2", children: [] } };
let A1 = {
  type: "div",
  key: "A1",
  props: { id: "A1", children: [B1, B2] },
};

let workInProgressRoot = {
  key: "ROOT",
  /**
   * ç¯€é»å¯¦ä¾‹ï¼Œ
   * å°æ–¼rootä¾†èªªï¼Œé€™è£¡ä¿ç•™domç¯€é»
   * å°æ–¼classçµ„ä»¶ä¾†èªªï¼Œä¿ç•™classå¯¦ä¾‹
   * å°æ–¼å‡½å¼çµ„ä»¶ä¾†èªªï¼Œæ˜¯ç©ºçš„ï¼Œå› ç‚ºæ²’æœ‰å¯¦ä¾‹
   *  */
  stateNode: container,
  props: { children: [A1] },
};
// ä¸‹ä¸€å€‹è¦è™•ç†çš„å–®å…ƒ
let nextUnitWork = workInProgressRoot;
// å°æ‡‰ diff çµæœæ˜¯è¦æ›¿æ›
const PLACEMEMT = "PLACEMEMT";
// å·¥ä½œå¾ªç’°
function workLoop(deadline) {
  // 2. é–‹å§‹å·¥ä½œï¼
  // å¦‚æœç•¶å‰è™•ç†çš„ç¯€é»å­˜åœ¨ï¼Œè€Œä¸”é‚„æœ‰å‰©é¤˜çš„æ™‚é–“
  // å°±å»æ§‹å»º ä¸‹ä¸€å€‹ fiber node
  console.log(nextUnitWork);
  while (nextUnitWork && deadline.timeRemaining() > 0) {
    nextUnitWork = performUnitWork(nextUnitWork);
  }
  // 5. å¦‚æœæ²’æœ‰ä¸‹ä¸€å€‹ç¯€é»äº†ï¼Œé€²å…¥ç¬¬äºŒéšæ®µ commit
  // ä¸Šåœ–çš„è—è‰²ç·š
  if (!nextUnitWork && workInProgressRoot) {
    commitRoot();
  }
  // ç¹¼çºŒä¸‹ä¸€å¹€çš„èª¿åº¦ä»»å‹™
  // requestIdleCallback(workLoop, { timeout: 500 });
}

function completeUnitOfWork(currentFiber) {
  const returnFiber = currentFiber.return;
  if (returnFiber) {
    if (!returnFiber.firstEffect) {
      returnFiber.firstEffect = currentFiber.firstEffect;
    }
    if (currentFiber.lastEffect) {
      if (returnFiber.lastEffect) {
        returnFiber.lastEffect.nextEffect = currentFiber.firstEffect;
      }
      returnFiber.lastEffect = currentFiber.lastEffect;
    }

    if (currentFiber.effectTag) {
      if (returnFiber.lastEffect) {
        if (currentFiber.key === "B1") {
          console.log(
            "returnFiber.returnFiber.lastEffect",
            returnFiber.lastEffect.key
          );
          console.log("returnFiber.firstEffect", returnFiber.lastEffect);
        }
        returnFiber.lastEffect.nextEffect = currentFiber;
      } else {
        returnFiber.firstEffect = currentFiber;
      }
      returnFiber.lastEffect = currentFiber;
    }
  }
}
// æ§‹å»º fiber tree
function performUnitWork(fiber) {
  // 4. å‰µå»º domç¯€é»
  startWork(fiber);
  // å¦‚æœæœ‰å­ç¯€é»å„ªå…ˆè™•ç†å­ç¯€é»ï¼Œä»¥ã€æ·±åº¦å„ªå…ˆã€
  if (fiber.child) {
    return fiber.child;
  }
  // å¦‚æœæ²’æœ‰å­ç¯€é»
  while (fiber) {
    // æ­¤ç¯€é»å·²ç¶“å®Œæˆ
    completeUnitOfWork(fiber); // æ”¶é›†effect
    // æª¢æŸ¥æ˜¯å¦æœ‰å…„å¼Ÿç¯€é»
    if (fiber.sibling) {
      return fiber.sibling;
    }
    fiber = fiber.return; // å›åˆ°çˆ¶å±¤ç´šï¼Œå†å»æ‰¾çˆ¶çš„å…„å¼Ÿç¯€é»
  }
}
function startWork(currentFiber) {
  // console.log("childFiber", currentFiber);
  if (!currentFiber.stateNode) {
    currentFiber.stateNode = document.createElement(currentFiber.type); //åˆ›å»ºçœŸå®DOM
    for (let key in currentFiber.props) {
      //å¾ªç¯å±æ€§èµ‹èµ‹å€¼ç»™çœŸå®DOM
      if (key !== "children" && key !== "key")
        currentFiber.stateNode.setAttribute(key, currentFiber.props[key]);
    }
    console.log("currentFiber", currentFiber);
  }

  let previousFiber;
  // åˆ›å»ºå­fiber
  currentFiber.props.children.forEach((child, index) => {
    let childFiber = {
      tag: "HOST",
      type: child.type,
      key: child.key,
      props: child.props,
      return: currentFiber,
      effectTag: "PLACEMENT",
      nextEffect: null,
    };
    if (index === 0) {
      currentFiber.child = childFiber;
    } else {
      previousFiber.sibling = childFiber;
    }
    previousFiber = childFiber;
  });
}
function commitRoot() {
  let fiber = workInProgressRoot.firstEffect;
  while (fiber) {
    console.log(fiber.key); //C1 C2 B1 B2 A1
    commitWork(fiber);
    fiber = fiber.nextEffect;
  }
  workInProgressRoot = null;
}
function commitWork(currentFiber) {
  currentFiber.return.stateNode.appendChild(currentFiber.stateNode);
}

// 1. è«‹æ±‚ç€è¦½å™¨åˆ†é…æ™‚é–“ requestIdleCallbackï¼Œåªè¦æœ‰æ™‚é–“å°±æœƒå»åŸ·è¡Œ workloop;
requestIdleCallback(workLoop, { timeout: 1000 });
```

#### åœ¨æºç¢¼ä¸­çš„ commit

| éšæ®µ                    | æ™‚æ©Ÿ            | ä¸»è¦ä»»å‹™                                                     | ç‰¹é»                                              |
| ----------------------- | --------------- | ------------------------------------------------------------ | ------------------------------------------------- |
| commit(before mutation) | åœ¨ DOM æ›´æ–°ä¹‹å‰ | æ•ç² DOM ä¹‹å‰çš„å¿«ç…§ï¼Œæº–å‚™ DOM ä¿®æ”¹ä»»å‹™                       | ç´€éŒ„æ›´æ–°å‰ç‹€æ…‹ï¼ˆå¦‚æ»¾å‹•å‰ä½ç½®ï¼‰ä¸æœƒå° DOM ä½œå‡ºä¿®æ”¹ |
| mutation                | åœ¨ DOM æ›´æ–°æ™‚   | åŸ·è¡Œ DOM å¢åˆªæ”¹ï¼Œæ¸…ç†èˆŠ Ref                                  | æœƒåŒæ­¥å®Œæˆ DOM çš„ä¿®æ”¹ï¼Œå¯èƒ½æœƒå½±éŸ¿æ€§èƒ½             |
| Layout                  | åœ¨ DOM æ›´æ–°å¾Œ   | è§¸ç™¼ä½ˆå±€ç›¸é—œä»»å‹™ï¼Œä¾‹å¦‚ componentDidUpdate å’Œ useLayoutEffect | å·²å®Œæˆæ›´æ–°ï¼Œå¯ä»¥å®‰å…¨çš„æ“ä½œ DOM æˆ–æ˜¯æ¸¬é‡ä½ˆå±€       |

ğŸŒŸ useEffect ä¸å®Œå…¨ç­‰æ–¼ componentDidMount åªèƒ½èªªæ˜¯æ›¿ä»£ï¼Œæ˜¯ç‚ºä»€éº¼å‘¢ï¼Ÿ

| ç‰¹æ€§           | componentDidMount  | useEffect          |
| -------------- | ------------------ | ------------------ |
| åŸ·è¡Œéšæ®µ       | commit-Layout      | commit å®Œæˆå¾Œ      |
| åŸ·è¡Œæ–¹å¼       | åŒæ­¥               | ç•°æ­¥               |
| DOM æ˜¯å¦å·²æ›´æ–° | æ˜¯ï¼Œå¯åŒæ­¥æ“ä½œ DOM | æ˜¯ï¼Œå¯ç•°æ­¥æ“ä½œ DOM |
| æ˜¯å¦é˜»å¡æ¸²æŸ“   | æ˜¯                 | å¦                 |

å…¶å¯¦ `useLayoutEffect` å’Œ `componentDidMount` åŸ·è¡Œæ™‚æ©Ÿæ¯”è¼ƒæ¥è¿‘ï¼Œéƒ½åœ¨ DOM æ›´æ–°å®Œæˆå"åŒæ­¥"æ‰§è¡Œï¼Œå¯ä»¥ç›´æ¥æ“ä½œ DOMã€‚åœ¨ç€è¦½å™¨ç¹ªè£½ä¹‹å‰åŸ·è¡Œã€‚

## å¸¸æåˆ°çš„å°ˆæœ‰åè© - å¢é‡å¼æ¸²æŸ“ (Incremental Rendering)ã€ä½µç™¼æ¨¡å¼ (Concurrent Mode)

### å¢é‡å¼æ¸²æŸ“ (Incremental Rendering)

å¢é‡å¼æ¸²æŸ“ æ˜¯ React æ¸²æŸ“éç¨‹ä¸­çš„ä¸€ç¨®ç­–ç•¥ï¼Œå…·é«”æŒ‡çš„æ˜¯å°‡æ¸²æŸ“éç¨‹æ‹†åˆ†ç‚ºè¨±å¤šå°çš„â€œå¡Šâ€æˆ–å–®å…ƒï¼Œé€™äº›å°å–®å…ƒå¯ä»¥æŒ‰éœ€é€æ­¥åŸ·è¡Œï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§é˜»å¡æ€§åœ°å®Œæˆæ•´å€‹æ¸²æŸ“éç¨‹ã€‚é€™æ¨£åšçš„ç›®çš„æ˜¯ç‚ºäº†é¿å…é•·æ™‚é–“çš„æ¸²æŸ“å·¥ä½œé˜»å¡ UI æ›´æ–°ï¼Œå¾è€Œæ¸›å°‘ UI å¡é “å’Œå»¶é²ã€‚
å¢é‡æ¸²æŸ“æ˜¯ä½µç™¼æ¨¡å¼çš„åŸºç¤ã€‚å¢é‡å¼æ¸²æŸ“ä¸»è¦é—œæ³¨æ¸²æŸ“çš„æ‹†åˆ†ã€‚

- åˆ†ç‰‡æ¸²æŸ“ï¼šå¢é‡å¼æ¸²æŸ“æŠŠæ¸²æŸ“éç¨‹åˆ†è§£ç‚ºè¨±å¤šå°çš„å·¥ä½œå–®å…ƒï¼Œé€™äº›å–®å…ƒå¯ä»¥åˆ†åˆ¥è™•ç†ä¸¦é€æ­¥åŸ·è¡Œã€‚React ä¸æœƒä¸€æ¬¡æ€§è™•ç†æ‰€æœ‰çš„æ›´æ–°ï¼Œè€Œæ˜¯æŠŠæ›´æ–°æ‹†æˆè¨±å¤šå°éƒ¨åˆ†ï¼Œé€æ­¥å®Œæˆã€‚
- ä¸­æ–·æ¸²æŸ“ï¼šå¢é‡å¼æ¸²æŸ“çš„éç¨‹ä¹Ÿæ”¯æŒä¸­æ–·ã€‚åœ¨æ¸²æŸ“éç¨‹ä¸­ï¼ŒReact å¯ä»¥åœ¨æŸäº›æ™‚å€™ä¸­æ–·ç•¶å‰çš„å·¥ä½œï¼Œå»è™•ç†æ›´é«˜å„ªå…ˆç´šçš„ä»»å‹™ï¼Œç„¶å¾Œå†å›ä¾†ç¹¼çºŒæ¸²æŸ“å‰©ä¸‹çš„éƒ¨åˆ†ã€‚

### ä½µç™¼æ¨¡å¼ (Concurrent Mode)

ä½µç™¼æ¨¡å¼ æ˜¯ React 16.3 å¼•å…¥çš„ä¸€å€‹é‡è¦ç‰¹æ€§ï¼Œä½µç™¼æ¨¡å¼æ˜¯ä¸€å€‹æ›´åŠ å…¨é¢çš„æ¶æ§‹ï¼Œå®ƒé‚„åŒ…æ‹¬äº†å¢é‡å¼æ¸²æŸ“ã€å„ªå…ˆç´šèª¿åº¦ã€Suspenseã€å»¶é²æ¸²æŸ“ã€éŒ¯èª¤é‚Šç•Œç­‰ã€‚å®ƒçš„ç›®çš„æ˜¯è®“ React æ¸²æŸ“éç¨‹æ›´åŠ éˆæ´»ï¼Œèƒ½å¤ æ ¹æ“šä¸åŒä»»å‹™çš„å„ªå…ˆç´šä¾†é€²è¡Œèª¿åº¦ã€‚ä½µç™¼æ¨¡å¼çš„é—œéµåœ¨æ–¼**èƒ½å¤ æ‰“æ–·å’Œæ¢å¾©æ¸²æŸ“**ï¼Œå¾è€Œä½¿ React èƒ½å¤ é«˜æ•ˆåœ°è™•ç†å¤§é‡çš„æ›´æ–°ä¸¦å„ªå…ˆéŸ¿æ‡‰ç”¨æˆ¶äº¤äº’ã€‚

- ç•°æ­¥æ¸²æŸ“ï¼šä½µç™¼æ¨¡å¼ä½¿å¾—æ¸²æŸ“éç¨‹è®Šæˆç•°æ­¥ï¼Œå…è¨± React åœ¨æ¸²æŸ“éç¨‹ä¸­æš«åœæˆ–ä¸­æ–·ï¼Œç­‰æœ‰ç©ºé–’æ™‚å†ç¹¼çºŒæ¸²æŸ“ã€‚é€™æ¨£ React å¯ä»¥åœ¨è™•ç†å¤§å‹æˆ–è¤‡é›œæ›´æ–°æ™‚ï¼Œä¸æœƒé˜»å¡ç”¨æˆ¶çš„äº¤äº’ã€‚
- å„ªå…ˆç´šèª¿åº¦ï¼šReact åœ¨ä½µç™¼æ¨¡å¼ä¸‹æœƒæ ¹æ“šä»»å‹™çš„å„ªå…ˆç´šé€²è¡Œèª¿åº¦ï¼Œç¢ºä¿é«˜å„ªå…ˆç´šçš„ä»»å‹™ï¼ˆä¾‹å¦‚ç”¨æˆ¶äº¤äº’ï¼‰èƒ½å¤ åŠæ™‚è™•ç†ï¼Œè€Œå°‡ä½å„ªå…ˆç´šçš„ä»»å‹™ï¼ˆå¦‚æ•¸æ“šåŠ è¼‰ã€å‹•ç•«ç­‰ï¼‰æ¨é²è™•ç†ã€‚
- Suspenseï¼šä½µç™¼æ¨¡å¼å’Œ Suspense å…±åŒå·¥ä½œï¼Œèƒ½å¤ å»¶é²æŸäº›éé—œéµä»»å‹™ï¼ˆå¦‚ç•°æ­¥æ•¸æ“šåŠ è¼‰ï¼‰ï¼Œä¸¦é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨ï¼Œç›´åˆ°æ•¸æ“šæˆ–çµ„ä»¶åŠ è¼‰å®Œæˆã€‚

## é‡é»æ•´ç†

1. jsx -> react element -> fiber tree -> dom tree
2. æ›´æ–°ç™¼ç”Ÿèª¿å’Œï¼ŒåŒæ™‚å­˜åœ¨å…©é¡†æ¨¹ï¼Œæ–°çš„æ¨¹æœƒå–ä»£èˆŠçš„æ¨¹ï¼Œç™¼ç”Ÿè®ŠåŒ–çš„ node æœƒæ¨™è¨˜ effect ï¼Œv17 ä¹‹å‰èª¿å’Œå®Œæˆå¾Œ ä»¥å–®éˆè¡¨çš„çµæ§‹æ”¶é›†ï¼Œé †åºç‚ºå­ç¯€é»ã€å­ç¯€é»å…„å¼Ÿç¯€é»ã€çˆ¶ç¯€é»ï¼Œä½†æ€§èƒ½å•é¡ŒåŠ ä¸Šå…§å­˜ç®¡ç†ä¸å¥½ï¼Œå°±ä½¿ç”¨ä¸€ç¨®æ–°çš„æ•¸æ“šçµæ§‹ effectList é›™å‘éˆè¡¨ä¾†æ¨™è¨˜
3. å¦‚æœçµ„ä»¶æ²’æœ‰åŸ·è¡Œ renderï¼Œå°±æ˜¯ç›´æ¥è¤‡ç”¨èˆŠæ¨¹ç¯€é»ï¼Œé™¤æ­¤ä¹‹å¤–è¦ç¶“é diff ç®—æ³• ä¾†åˆ¤æ–·æ˜¯è¦å…‹éš†é‚„æ˜¯å‰µå»º
4. diff ç®—æ³•æ˜¯æ¯”è¼ƒå·²ç¶“åŒ¹é…çš„çˆ¶ç¯€é»çš„å­ç¯€é»ï¼Œä¸æœƒè·¨çˆ¶ç¯€é»æ¯”è¼ƒ
5. diff ç®—æ³•å¦‚æœ key å’Œ type ç›¸åŒå‰‡å…‹éš†ï¼Œä¸ç„¶å°±é‡æ–°å‰µå»º

---

> å­¸ç¿’è³‡æ–™ï¼š
>
> [React Fiber åŸç†](https://juejin.cn/post/6962449722275528712)
>
> [ç”±æ·ºå…¥æ·± React çš„ Fiber æ¶æ§‹](https://segmentfault.com/a/1190000022960789#item-6-13)
>
> [æ‰‹æ’• React Fiber æºç ](https://www.bilibili.com/video/BV1vP4y1w7TN/?share_source=copy_web&vd_source=34ac1b8e3ce252ba440c815f2d4f6cd3)
>
> [åˆ©ç”¨ react scheduler æ€æƒ³ï¼Œå®ç°ä»»åŠ¡çš„æ‰“æ–­ä¸æ¢å¤](https://juejin.cn/post/7345746216150417446)
